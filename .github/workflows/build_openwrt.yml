name: 编译 OpenWRT（自定义 SSH 配置）
on:
  push:
    branches: [ main ]  # 触发分支（可修改）
    paths:
      - '.config'       # 仅当 .config 文件变更时触发
  pull_request:
    branches: [ main ]
  workflow_dispatch:    # 允许手动触发

jobs:
  compile:
    runs-on: ubuntu-22.04  # 推荐使用 22.04（兼容性更好）
    steps:
      - name: 检查代码仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 安装编译依赖
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev \
            file wget curl libelf-dev liblzma-dev patchutils

      - name: 下载 OpenWRT 源码（以 23.05 稳定版为例）
        run: |
          git clone -b openwrt-23.05 --single-branch https://github.com/openwrt/openwrt.git openwrt
          cd openwrt

      - name: 替换自定义 .config（含 SSH 配置）
        run: |
          # 将仓库根目录的 .config 复制到 OpenWRT 源码目录
          cp -f .config openwrt/.config
          cd openwrt
          # 加载配置并安装依赖包
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 编译 OpenWRT 镜像
        run: |
          cd openwrt
          # 多线程编译（根据 GitHub 服务器核心数自动调整）
          make -j$(nproc) defconfig download clean world || make -j1 V=s  # 失败时单线程编译并输出详细日志

      - name: 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-ssh-custom
          path: |
            openwrt/bin/targets/**/*.bin  # 固件文件
            openwrt/bin/targets/**/*.img  # 镜像文件
            openwrt/.config               # 编译时使用的配置文件（方便回溯）
          retention-days: 30  # 产物保留 30 天
