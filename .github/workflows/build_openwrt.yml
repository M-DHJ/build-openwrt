name: 编译 OpenWRT v24.10.4 (x86/64) + SSH 连接
on:
  workflow_dispatch:  # 仅支持手动触发（避免自动编译时暴露 SSH）

jobs:
  compile-openwrt:
    runs-on: ubuntu-22.04
    steps:
      - name: 检查代码仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 安装编译依赖
        run: |
          sudo apt update && sudo apt full-upgrade -y
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses5-dev libssl-dev python3 python3-distutils rsync unzip zlib1g-dev \
            file wget curl libelf-dev liblzma-dev patchutils swig libpcre3-dev libffi-dev \
            python3-setuptools python3-pip

      - name: 下载 OpenWRT v24.10.4 源码
        run: |
          git clone --depth 1 --branch v24.10.4 https://github.com/openwrt/openwrt.git openwrt
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 开启 SSH 会话（临时连接）
        uses: mxschmitt/action-tmate@v3  # 核心插件，生成 SSH 连接信息
        with:
          limit-access-to-actor: true  # 仅允许仓库所有者连接（安全）
          # 可选：设置会话超时时间（默认 1h，超时后 workflow 继续）
          timeout-minutes: 60

      - name: 编译 OpenWRT 固件（SSH 配置完成后自动执行）
        run: |
          cd openwrt
          make -j$(nproc) download clean world || make -j1 V=s

      - name: 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-v24.10.4-x86_64
          path: |
            openwrt/bin/targets/x86/64/*.bin
            openwrt/bin/targets/x86/64/*.img
            openwrt/.config
          retention-days: 90
